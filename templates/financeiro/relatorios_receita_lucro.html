{% extends 'base.html' %}

{% block title %}Relatórios de Receita e Lucro - Controle Financeiro{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-graph-up"></i> Relatórios de Receita e Lucro</h1>
            <a href="{% url 'relatorio_detalhado' %}" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-text"></i> Relatório Detalhado
            </a>
        </div>
    </div>
</div>

<!-- Filtro de Período -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="periodo" class="form-label">Período</label>
                        <select class="form-select" id="periodo" name="periodo" onchange="this.form.submit()">
                            <option value="dia" {% if periodo == 'dia' %}selected{% endif %}>Hoje</option>
                            <option value="semana" {% if periodo == 'semana' %}selected{% endif %}>Esta Semana</option>
                            <option value="mes" {% if periodo == 'mes' %}selected{% endif %}>Este Mês</option>
                            <option value="ano" {% if periodo == 'ano' %}selected{% endif %}>Este Ano</option>
                            <option value="todos" {% if periodo == 'todos' %}selected{% endif %}>Todos os Períodos</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i>
                            <strong>Período Selecionado:</strong> {{ titulo_periodo }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Resumo Estatístico -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="bi bi-cart-check fs-1 mb-2"></i>
                <h6>Total de Vendas</h6>
                <h3>{{ stats.total_vendas }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="bi bi-currency-dollar fs-1 mb-2"></i>
                <h6>Receita Total</h6>
                <h3>R$ {{ stats.receita_total|floatformat:0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="bi bi-graph-up fs-1 mb-2"></i>
                <h6>Lucro Total</h6>
                <h3>R$ {{ stats.lucro_total|floatformat:0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <i class="bi bi-percent fs-1 mb-2"></i>
                <h6>Margem Média</h6>
                <h3>{{ stats.margem_media|floatformat:1 }}%</h3>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row mb-4">
    <!-- Gráfico de Linha - Receita e Lucro Diário -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-graph-up"></i> Receita e Lucro - Últimos 30 Dias</h5>
            </div>
            <div class="card-body">
                <canvas id="graficoLinha" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Gráfico de Pizza - Vendas por Categoria -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-pie-chart"></i> Vendas por Categoria</h5>
            </div>
            <div class="card-body">
                <canvas id="graficoPizza" width="300" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabelas de Análise -->
<div class="row">
    <!-- Vendas por Categoria -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-tags"></i> Análise por Categoria</h5>
            </div>
            <div class="card-body">
                {% if vendas_categoria %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Vendas</th>
                                <th>Receita</th>
                                <th>Lucro</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for categoria in vendas_categoria %}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">{{ categoria.produto__categoria__nome }}</span>
                                </td>
                                <td>{{ categoria.quantidade }}</td>
                                <td class="text-success">R$ {{ categoria.total|floatformat:2 }}</td>
                                <td class="text-primary">R$ {{ categoria.lucro|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="bi bi-info-circle fs-1 mb-3"></i>
                    <p>Nenhuma venda encontrada no período selecionado.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Top Produtos -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-trophy"></i> Top 10 Produtos</h5>
            </div>
            <div class="card-body">
                {% if produtos_top %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Qtd</th>
                                <th>Receita</th>
                                <th>Lucro</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for produto in produtos_top %}
                            <tr>
                                <td>
                                    <strong>{{ produto.produto__nome }}</strong>
                                    <br><small class="text-muted">{{ produto.produto__categoria__nome }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ produto.quantidade }}</span>
                                </td>
                                <td class="text-success">R$ {{ produto.total|floatformat:2 }}</td>
                                <td class="text-primary">R$ {{ produto.lucro|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="bi bi-info-circle fs-1 mb-3"></i>
                    <p>Nenhuma venda encontrada no período selecionado.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dados dos gráficos
    const vendasDiarias = {{ vendas_diarias_json|safe }};
    const dadosPizza = {{ dados_pizza_json|safe }};
    
    // Configuração do gráfico de linha
    const ctxLinha = document.getElementById('graficoLinha').getContext('2d');
    new Chart(ctxLinha, {
        type: 'line',
        data: {
            labels: vendasDiarias.map(item => item.data),
            datasets: [{
                label: 'Receita (R$)',
                data: vendasDiarias.map(item => item.receita),
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Lucro (R$)',
                data: vendasDiarias.map(item => item.lucro),
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolução Diária'
                },
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // Configuração do gráfico de pizza
    if (dadosPizza.length > 0) {
        const ctxPizza = document.getElementById('graficoPizza').getContext('2d');
        new Chart(ctxPizza, {
            type: 'doughnut',
            data: {
                labels: dadosPizza.map(item => item.nome),
                datasets: [{
                    data: dadosPizza.map(item => item.valor),
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40',
                        '#FF6384',
                        '#C9CBCF'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': R$ ' + value.toLocaleString('pt-BR') + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    } else {
        // Mostrar mensagem se não há dados
        document.getElementById('graficoPizza').style.display = 'none';
        const container = document.getElementById('graficoPizza').parentElement;
        container.innerHTML = '<div class="text-center text-muted"><i class="bi bi-info-circle fs-1 mb-3"></i><p>Nenhum dado para exibir</p></div>';
    }
});
</script>
{% endblock %}
